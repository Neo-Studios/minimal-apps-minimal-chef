name: Android Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
    
    - name: Create google-services.json
      run: |
        cat > android/app/google-services.json << 'EOF'
        {
          "project_info": {
            "project_number": "${{ secrets.FIREBASE_PROJECT_NUMBER }}",
            "project_id": "${{ secrets.FIREBASE_PROJECT_ID }}",
            "storage_bucket": "${{ secrets.FIREBASE_STORAGE_BUCKET }}"
          },
          "client": [
            {
              "client_info": {
                "mobilesdk_app_id": "${{ secrets.FIREBASE_ANDROID_APP_ID }}",
                "android_client_info": {
                  "package_name": "com.example.minimal_chef"
                }
              },
              "oauth_client": [
                {
                  "client_id": "${{ secrets.FIREBASE_OAUTH_CLIENT_ID }}",
                  "client_type": 3
                }
              ],
              "api_key": [
                {
                  "current_key": "${{ secrets.FIREBASE_ANDROID_API_KEY }}"
                }
              ],
              "services": {
                "appinvite_service": {
                  "other_platform_oauth_client": [
                    {
                      "client_id": "${{ secrets.FIREBASE_OAUTH_CLIENT_ID }}",
                      "client_type": 3
                    }
                  ]
                }
              }
            }
          ],
          "configuration_version": "1"
        }
        EOF
    
    - name: Create Firebase Options
      run: |
        cat > lib/firebase_options.dart << 'EOF'
        import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
        import 'package:flutter/foundation.dart'
            show defaultTargetPlatform, kIsWeb, TargetPlatform;

        class DefaultFirebaseOptions {
          static FirebaseOptions get currentPlatform {
            if (kIsWeb) {
              return web;
            }
            switch (defaultTargetPlatform) {
              case TargetPlatform.android:
                return android;
              case TargetPlatform.iOS:
                return ios;
              case TargetPlatform.macOS:
                return macos;
              case TargetPlatform.windows:
                throw UnsupportedError(
                  'DefaultFirebaseOptions have not been configured for windows - '
                  'you can reconfigure this by running the FlutterFire CLI again.',
                );
              case TargetPlatform.linux:
                throw UnsupportedError(
                  'DefaultFirebaseOptions have not been configured for linux - '
                  'you can reconfigure this by running the FlutterFire CLI again.',
                );
              default:
                throw UnsupportedError(
                  'DefaultFirebaseOptions are not supported for this platform.',
                );
            }
          }

          static const FirebaseOptions web = FirebaseOptions(
            apiKey: '${{ secrets.FIREBASE_WEB_API_KEY }}',
            appId: '${{ secrets.FIREBASE_WEB_APP_ID }}',
            messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}',
            projectId: '${{ secrets.FIREBASE_PROJECT_ID }}',
            authDomain: '${{ secrets.FIREBASE_AUTH_DOMAIN }}',
            storageBucket: '${{ secrets.FIREBASE_STORAGE_BUCKET }}',
          );

          static const FirebaseOptions android = FirebaseOptions(
            apiKey: '${{ secrets.FIREBASE_ANDROID_API_KEY }}',
            appId: '${{ secrets.FIREBASE_ANDROID_APP_ID }}',
            messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}',
            projectId: '${{ secrets.FIREBASE_PROJECT_ID }}',
            storageBucket: '${{ secrets.FIREBASE_STORAGE_BUCKET }}',
          );

          static const FirebaseOptions ios = FirebaseOptions(
            apiKey: '${{ secrets.FIREBASE_IOS_API_KEY }}',
            appId: '${{ secrets.FIREBASE_IOS_APP_ID }}',
            messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}',
            projectId: '${{ secrets.FIREBASE_PROJECT_ID }}',
            storageBucket: '${{ secrets.FIREBASE_STORAGE_BUCKET }}',
            iosBundleId: '${{ secrets.FIREBASE_IOS_BUNDLE_ID }}',
          );

          static const FirebaseOptions macos = FirebaseOptions(
            apiKey: '${{ secrets.FIREBASE_MACOS_API_KEY }}',
            appId: '${{ secrets.FIREBASE_MACOS_APP_ID }}',
            messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}',
            projectId: '${{ secrets.FIREBASE_PROJECT_ID }}',
            storageBucket: '${{ secrets.FIREBASE_STORAGE_BUCKET }}',
            iosBundleId: '${{ secrets.FIREBASE_MACOS_BUNDLE_ID }}',
          );
        }
        EOF
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Build APK
      run: flutter build apk --release
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-release
        path: build/app/outputs/flutter-apk/app-release.apk
